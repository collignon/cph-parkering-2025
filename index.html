<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Private Parking in Copenhagen - A Visual Essay</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --copenhagen-blue: #1e3a8a;
            --copenhagen-light-blue: #3b82f6;
            --danish-green: #059669;
            --problem-red: #dc2626;
            --warm-amber: #f59e0b;
            --neutral-dark: #374151;
            --neutral-light: #f8fafc;
            --glass-bg: rgba(30, 58, 138, 0.15);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Source Sans Pro', sans-serif;
            overflow-x: hidden;
            transition: background-color 0.6s ease-in-out;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }

        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Hide map during solid background */
        body.solid-background-active #map {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #mapInset {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 150px;
            z-index: 2;
            border: 2px solid #fff;
            border-radius: 4px;
        }

        #story {
            position: relative;
            z-index: 3;
        }

        .step {
            padding: 60px 40px;
            margin-bottom: 80vh;
            background: rgba(248, 250, 252, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.1);
            max-width: 600px;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease-in-out;
        }

        /* Extra spacing after the first text box for better reading flow */
        #intro.step {
            margin-bottom: 120vh;
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        /* Extra spacing for key transition chapters */
        #aktuel-bel√¶gning-intro.step,
        #parking-visualization.step,
        #space-stats.step,
        #hvad-tager-parkering.step {
            margin-bottom: 120vh;
        }

        /* Show intro when scrolling starts */
        #intro.step.show {
            opacity: 1;
            transform: translateY(0);
        }

        .step.active {
            background: rgba(248, 250, 252, 0.98);
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.2);
        }

        .step h3 {
            margin: 0 0 20px 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--copenhagen-blue);
        }

        .step p {
            margin: 0 0 15px 0;
            color: var(--neutral-dark);
        }

        .step a {
            color: var(--copenhagen-light-blue);
            text-decoration: none;
        }

        .step a:hover {
            text-decoration: underline;
            color: var(--copenhagen-blue);
        }

        /* Alignment classes */
        .lefty {
            margin-left: 5%;
        }

        .righty {
            margin-right: 5%;
            margin-left: auto;
        }

        .centered {
            margin: 0 auto;
        }

        .fully {
            width: 100%;
            margin: 0;
        }

        /* Header and footer */
        #header {
            padding: 60px 40px;
            background: var(--copenhagen-blue);
            color: white;
            text-align: center;
        }

        #header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        #header h2 {
            margin: 0 0 20px 0;
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.9;
        }

        #header p {
            margin: 0;
            font-size: 1rem;
            opacity: 0.8;
        }

        #footer {
            padding: 40px;
            background: var(--copenhagen-blue);
            color: white;
            text-align: center;
        }

        #footer a {
            color: var(--warm-amber);
        }

        /* Image slides */
        .step.image-slide {
            position: relative;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            padding: 0;
            margin-bottom: 100vh;
            height: 100vh;
            max-width: none;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.image-slide .content {
            background: rgba(248, 250, 252, 0.95);
            color: var(--neutral-dark);
            padding: 40px;
            border-radius: 8px;
            max-width: 600px;
            text-align: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.15);
        }

        .step.image-slide h3 {
            color: var(--copenhagen-blue);
            font-size: 2.2rem;
            margin-bottom: 20px;
        }

        .step.image-slide p {
            color: var(--neutral-dark);
            font-size: 1.1rem;
        }

        /* Sticky graphic pattern */
        .step.sticky-graphic {
            position: relative;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            padding: 0;
            margin-bottom: 50vh;
            height: 100vh;
            max-width: none;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 8%;
            background-color: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
        }

        /* Remove the dark overlay completely */
        .step.sticky-graphic::before {
            display: none;
        }

        .step.sticky-graphic .content {
            position: relative;
            z-index: 2;
            background: rgba(248, 250, 252, 0.95);
            color: var(--neutral-dark);
            padding: 35px 40px;
            border-radius: 12px;
            max-width: 420px;
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.15);
        }

        .step.sticky-graphic h3 {
            color: var(--copenhagen-blue);
            font-size: 1.8rem;
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .step.sticky-graphic p {
            color: var(--neutral-dark);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        /* Sticky graphic sequence - keeps the same background for multiple chapters */
        .sticky-sequence {
            position: relative;
        }

        .sticky-sequence .step:not(:last-child) {
            margin-bottom: 50vh;
        }

        /* Create a fixed background container for sticky sequences */
        body.sticky-sequence-active::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* Arrogance of space background */
        body.arrogance-sequence::before {
            background-image: url('./assets/Paris 1 by Mikael Colville Andersen.jpg');
        }

        /* Transformation sequence background */
        body.transformation-sequence::before {
            background-image: url('./assets/Paris is Looking Great.webp');
        }

        /* Make sure sticky graphic steps are transparent during sequences */
        body.sticky-sequence-active .step.sticky-graphic {
            background: transparent !important;
            background-image: none !important;
        }

        /* Hide map during sticky graphic sequence */
        body.sticky-sequence-active #map {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .step {
                padding: 40px 20px;
                margin-left: 5%;
                margin-right: 5%;
                max-width: none;
            }

            .step h3 {
                font-size: 1.5rem;
            }

            #header h1 {
                font-size: 2rem;
            }

            .step.image-slide .content {
                padding: 30px 20px;
                margin: 0 20px;
            }

            .step.image-slide h3 {
                font-size: 1.8rem;
            }

            .step.sticky-graphic {
                justify-content: center;
                padding: 40px 20px;
                padding-left: 5%;
            }

            .step.sticky-graphic .content {
                margin-left: 0;
                max-width: none;
                margin: 0 20px;
                background: rgba(255, 255, 255, 0.95); /* Clean white background */
                backdrop-filter: none; /* Remove blur */
                box-shadow: none; /* Remove shadow completely */
                border: 2px solid rgba(255, 255, 255, 1); /* Solid white border */
            }

            .step.sticky-graphic h3 {
                font-size: 1.7rem;
            }
        }

        /* Space comparison visualization */
        .space-comparison {
            margin: 40px auto; /* Centered with more vertical margin */
            padding: 30px;
            background: #ffffff; /* Brighter background */
            border-radius: 12px; /* Softer radius */
            border: 1px solid #dee2e6; /* Lighter border */
            max-width: 700px; /* Control max width for better readability */
            box-shadow: 0 6px 25px rgba(0,0,0,0.08); /* Softer shadow */
        }

        .space-comparison h3 {
            color: #2c3e50;
            margin-bottom: 20px; /* Increased space */
            font-size: 1.8rem; /* Slightly larger */
            text-align: center;
        }

        .total-spaces {
            font-size: 1.15rem; /* Slightly larger */
            margin-bottom: 25px;
            color: #495057; /* Softer dark color */
            font-weight: 500;
            text-align: center;
        }

        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive columns */
            gap: 20px; /* Increased gap */
            margin-bottom: 25px;
        }

        .alternative-item {
            display: flex;
            align-items: flex-start; /* Align items to the top */
            padding: 20px;
            background: #f8f9fa; /* Light background for items */
            border-radius: 8px;
            /* border-left: 5px solid var(--alt-color, #3498db); Remove inline style dependency */
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .alternative-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .alt-icon {
            font-size: 2.2rem; /* Slightly larger icon */
            margin-right: 18px;
            flex-shrink: 0;
            margin-top: 3px; /* Align icon better with text */
            width: 40px; /* Give icon a fixed width for alignment */
            text-align: center;
        }

        .alt-content h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.2rem; /* Slightly larger title */
            line-height: 1.3;
        }

        .alt-impact {
            margin: 0 0 8px 0;
            color: #17a2b8; /* Changed color for impact text, e.g. Bootstrap's info color */
            font-weight: 500;
            font-size: 1rem;
            line-height: 1.4;
        }

        .alt-description {
            color: #6c757d;
            font-style: italic;
            font-size: 0.85rem; /* Smaller for de-emphasis */
            line-height: 1.3;
        }

        .szell-reference {
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            margin-top: 10px;
        }

        .szell-reference em {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Mobile responsive adjustments for space comparison */
        @media (max-width: 768px) {
            .space-comparison {
                margin: 30px 15px; /* Adjust margin for smaller screens */
                padding: 20px;
            }
            .alternatives-grid {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 15px;
            }
            .alternative-item {
                padding: 15px;
            }
            .alt-icon {
                font-size: 2rem;
                margin-right: 15px;
            }
            .alt-content h4 {
                font-size: 1.1rem;
            }
            .alt-impact {
                font-size: 0.95rem;
            }
        }

        /* Styles for the new scrollytelling space alternatives */
        .space-alternatives-wrapper {
            /* This wrapper will be dynamically added. 
               It can inherit styles from .space-comparison or have its own */
            margin: 20px auto; /* Adjust as needed */
            padding: 20px;
            background: rgba(255, 255, 255, 0.9); /* Slight transparency if desired over a chapter background */
            border-radius: 10px;
            max-width: 700px; /* Consistent with previous .space-comparison */
        }

        .space-alternatives-wrapper .alternatives-grid {
            /* Styles for the grid within the new wrapper */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .space-alternatives-wrapper .alternative-item {
            /* Styles for individual items within the new wrapper */
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: #f0f0f0; /* Slightly different background for items */
            border-radius: 8px;
            /* border-left is set inline by JS */
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            /* transition for opacity/transform is set inline by JS */
        }
        
        /* Additional style for active/highlighted alternative if needed beyond JS inline styles */
        .space-alternatives-wrapper .alternative-item.active-alternative {
            /* Example: a more prominent shadow or border */
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .space-alternatives-wrapper .alt-icon {
            font-size: 2rem;
            margin-right: 15px;
            flex-shrink: 0;
            margin-top: 2px;
            width: 35px;
            text-align: center;
        }

        .space-alternatives-wrapper .alt-content h4 {
            margin: 0 0 6px 0;
            color: #2c3e50;
            font-size: 1.15rem;
        }

        .space-alternatives-wrapper .alt-description {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .space-alternatives-wrapper .szell-reference {
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            margin-top: 5px;
        }

        .space-alternatives-wrapper .szell-reference em {
            color: #6c757d;
            font-size: 0.85rem;
        }

        /* Responsive for the new wrapper */
        @media (max-width: 768px) {
            .space-alternatives-wrapper {
                margin: 20px 10px;
                padding: 15px;
            }
            .space-alternatives-wrapper .alternatives-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* Impact statistics */
        .impact-stats {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .impact-stats h3 {
            color: white;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Impact explanation */
        .impact-explanation {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .impact-explanation p {
            margin-bottom: 15px;
        }

        .impact-explanation ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .impact-explanation li {
            margin-bottom: 8px;
        }

        .source-note {
            font-size: 0.9rem;
            color: #6c757d;
            font-style: italic;
            margin-bottom: 0;
        }

        /* Danish urbanism achievements */
        .danish-achievements {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 8px;
        }

        .danish-achievements h3 {
            color: white;
            margin-bottom: 20px;
        }

        .achievement-item {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Danish impact simple styles */
        .danish-impact-simple {
            margin: 40px 0;
            padding: 0;
            background: none;
            color: inherit;
            border-radius: 0;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .impact-item {
            text-align: center;
            padding: 25px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .impact-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .impact-number {
            display: block;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .impact-label {
            font-size: 0.95rem;
            color: #6c757d;
            line-height: 1.4;
            font-weight: 500;
        }

        .paradox-highlight {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e74c3c;
            text-align: center;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.1);
        }

        .paradox-highlight h4 {
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            color: #e74c3c;
            font-weight: 600;
        }

        .paradox-stats {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .bad-stat {
            background: #fff5f5;
            color: #c53030;
            padding: 12px 18px;
            border-radius: 6px;
            border: 1px solid #feb2b2;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .good-stat {
            background: #f0fff4;
            color: #38a169;
            padding: 12px 18px;
            border-radius: 6px;
            border: 1px solid #9ae6b4;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Contribution form */
        .contribution-form {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .contribution-form h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .contribution-form input,
        .contribution-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .contribution-form button {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }

        .contribution-form button:hover {
            background: #2980b9;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .alternatives-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .alternative-item {
                flex-direction: column;
                text-align: center;
            }
            
            .alt-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .impact-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .impact-item {
                padding: 20px 10px;
            }
            
            .impact-number {
                font-size: 2rem;
            }
            
            .impact-label {
                font-size: 0.85rem;
            }
            
            .paradox-highlight {
                padding: 20px;
            }
            
            .paradox-stats {
                flex-direction: column;
                align-items: center;
            }
            
            .bad-stat, .good-stat {
                text-align: center;
                width: auto;
                min-width: 200px;
            }
        }

        /* Solid background chapters */
        .step.solid-background {
            position: relative;
            background: none !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
        }

        .step.solid-background::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            transition: opacity 0.5s ease;
        }

        /* Custom styles for dark background chapters */
        #aktuel-bel√¶gning.step,
        #kommunale-lejeaftaler.step {
            color: white; /* Default text color for these chapters */
        }

        #aktuel-bel√¶gning.step h3,
        #kommunale-lejeaftaler.step h3 {
            color: white !important; /* Ensure title is white */
            font-size: 2rem; /* Make title a bit larger */
        }

        #aktuel-bel√¶gning.step p,
        #kommunale-lejeaftaler.step p {
            color: #f0f0f0 !important; /* Slightly off-white for paragraph for softer contrast */
            font-size: 1.1rem; /* Make paragraph text a bit larger */
        }
        
        #aktuel-bel√¶gning.step a,
        #kommunale-lejeaftaler.step a {
            color: var(--copenhagen-light-blue) !important;
        }

        /* Fixed styling for kommunale-lejeaftaler chapter - always consistent */
        #kommunale-lejeaftaler.step {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #2c3e50 !important;
            padding: 25px !important;
            border-radius: 12px !important;
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.2) !important;
            backdrop-filter: blur(10px) !important;
            max-width: 480px !important; /* Reduced from 600px to fit better with chart */
            margin-left: 5vw !important;
            margin-right: auto !important;
            position: relative !important;
            z-index: 5 !important;
            transition: none !important; /* No transitions to prevent layout shifts */
        }

        #kommunale-lejeaftaler.step h3 {
            color: #2c3e50 !important;
            margin-bottom: 18px !important;
            font-size: 1.7rem !important; /* Slightly smaller to fit better */
        }

        #kommunale-lejeaftaler.step p {
            color: #34495e !important;
            line-height: 1.6 !important;
            font-size: 0.95rem !important; /* Slightly smaller for better fit */
        }

        #kommunale-lejeaftaler.step a {
            color: var(--copenhagen-light-blue) !important;
        }

        /* Fixed styling for aktuel-bel√¶gning chapter - now transparent */
        #aktuel-bel√¶gning.step {
            background: transparent !important; /* Remove background completely */
            color: white !important; /* White text for dark background */
            padding: 30px !important;
            border-radius: 0 !important; /* No border radius needed */
            box-shadow: none !important; /* No shadow needed */
            backdrop-filter: none !important; /* No blur needed */
            max-width: 520px !important;
            margin-left: 5vw !important; /* Keep left positioning */
            margin-right: auto !important;
            margin-bottom: 90vh !important; /* Reduced from 140vh to match better timing */
            position: relative !important;
            z-index: 5 !important;
            transition: none !important;
        }

        #aktuel-bel√¶gning.step h3 {
            color: white !important; /* Ensure title is white */
            margin-bottom: 20px !important;
            font-size: 1.8rem !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important; /* Add subtle shadow for readability */
        }

        #aktuel-bel√¶gning.step p {
            color: #f0f0f0 !important; /* Light text */
            line-height: 1.6 !important;
            font-size: 1rem !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important; /* Add subtle shadow for readability */
        }

        #aktuel-bel√¶gning.step a {
            color: var(--warm-amber) !important; /* Amber for links on dark background */
        }

        /* Ensure hvad-tager-parkering has full width and proper spacing */
        #hvad-tager-parkering.step {
            background: rgba(248, 250, 252, 0.95) !important;
            max-width: 700px !important; /* Slightly wider for better readability */
            margin-left: auto !important;
            margin-right: auto !important;
            margin-top: 60vh !important; /* Add top margin for visual separation */
            padding: 50px 40px !important; /* More generous padding */
            border-radius: 12px !important;
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.2) !important;
            backdrop-filter: blur(10px) !important;
            margin-bottom: 120vh !important; /* Extra space after this chapter */
        }

        #hvad-tager-parkering.step h3 {
            color: #2c3e50 !important;
            margin-bottom: 25px !important;
            font-size: 1.9rem !important;
            text-align: center !important;
        }

        #hvad-tager-parkering.step p {
            color: #34495e !important;
            line-height: 1.7 !important;
            font-size: 1.05rem !important;
            text-align: center !important;
        }

        #hvad-tager-parkering.step a {
            color: var(--copenhagen-light-blue) !important;
        }

        /* Improved transitions for chapters affected by chart */
        #vesterbro-parking.step {
            transition: all 0.6s ease-in-out;
        }

        /* Add more bottom padding to the intro text chapter before the visualization */
        #aktuel-bel√¶gning-intro.step {
            padding-bottom: 120px; /* Increased from default 60px */
        }

        /* Adjustments for the visualization placeholder chapter if needed */
        #parking-visualization.step {
            min-height: 100vh; /* Ensure it takes up some scroll space even if empty of its own content */
            /* margin-bottom: 120vh; is already set, which is good */
        }

        /* Add more bottom margin to the conclusion chapter to push subsequent content down */
        #aktuel-bel√¶gning-conclusion.step {
            margin-bottom: 150vh; /* Increased from default 80vh to push space-stats down */
        }

        /* Style for the text content of aktuel-bel√¶gning-conclusion */
        #aktuel-bel√¶gning-conclusion .mapboxgl-scroll-overlay-content {
            background-color: rgba(44, 62, 80, 0.85); /* Semi-transparent dark blue, matches header */
            padding: 2em; /* Increased padding */
            border-radius: 8px;
            color: white; /* Ensuring text is white for readability */
            box-shadow: 0 4px 20px rgba(0,0,0,0.25); /* A bit more pronounced shadow */
        }
        
        /* Ensure links within this styled box are also visible */
        #aktuel-bel√¶gning-conclusion .mapboxgl-scroll-overlay-content a {
            color: #7ec6ff; /* Lighter blue for links on dark background */
        }

        /* New styles for side-by-side image and text */
        .side-by-side-layout {
            display: flex;
            align-items: flex-start; /* Align items to the top */
            gap: 20px; /* Space between image and text */
        }

        .side-by-side-layout .image-column {
            flex: 0 0 40%; /* Image takes up 40% of the width, does not grow or shrink */
            max-width: 40%;
        }

        .side-by-side-layout .image-column img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .side-by-side-layout .text-column {
            flex: 1; /* Text takes up the remaining space */
            max-width: calc(60% - 20px); /* Adjust for gap */
        }

        /* Adjustments for centered chapters with side-by-side layout */
        .step.centered .side-by-side-layout {
            max-width: 900px; /* Or a value that you prefer for the overall width */
            margin-left: auto;
            margin-right: auto;
        }
        
        .step.centered {
            max-width: 1000px; /* Increase max-width for centered steps that use this layout */
        }

        /* Custom spacing for specific chapters */
        #transformation-intro.step,
        #transformation-hidalgo.step {
            margin-bottom: 120vh; /* More scroll space between these Paris chapters */
        }

        #transformation-results.step {
            margin-bottom: 150vh; /* More scroll space after the Paris sequence */
        }

        /* Sticky cost chart container */
        #sticky-cost-chart-container {
            position: fixed;
            right: 3%;
            top: 15vh;
            width: 40%;
            max-width: 420px;
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(30, 58, 138, 0.25);
            z-index: 10;
            display: none;
            backdrop-filter: blur(15px);
            transition: opacity 0.6s ease-in-out;
        }

        #sticky-cost-chart-container h3 {
            margin: 0 0 8px 0;
            font-size: 1.4rem;
            color: #2c3e50;
            font-weight: 700;
        }

        #sticky-cost-chart-container .chart-note {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
            line-height: 1.4;
        }

        /* Parking visualization sticky container - transparent like aktuel-bel√¶gning text */
        #sticky-parking-viz-container {
            position: fixed;
            right: 2%; /* Much closer to the edge */
            top: 18vh; /* Slightly higher to better align */
            width: 32%; /* Narrower container width */
            max-width: 350px; /* Smaller max-width for tighter fit */
            background: transparent !important; /* Remove background completely */
            padding: 18px; /* Less padding around the content */
            border-radius: 0 !important; /* No border radius needed */
            box-shadow: none !important; /* No shadow needed */
            z-index: 10;
            display: none;
            backdrop-filter: none !important; /* No blur needed */
            transition: opacity 0.3s ease-in-out;
        }

        #sticky-parking-viz-container h3 {
            margin: 0 0 6px 0; /* Less margin for tighter layout */
            font-size: 1.2rem; /* Slightly smaller title */
            color: white !important; /* White text for dark background */
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important; /* Add shadow for readability */
        }

        /* Make sure all content in the parking viz container is white on dark background */
        #sticky-parking-viz-container * {
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* Smooth transitions for chapters with parking visualization */
        .step.with-parking-viz {
            transition: margin-left 0.5s ease-in-out, margin-right 0.5s ease-in-out, max-width 0.5s ease-in-out;
        }
        
        /* Ensure consistent spacing for chapters that might have parking viz */
        #aktuel-bel√¶gning.step,
        #hvad-tager-parkering.step {
            transition: margin-left 0.5s ease-in-out, margin-right 0.5s ease-in-out, max-width 0.5s ease-in-out;
        }

        /* Fixed styling for Paris section chapters - add dark background for readability */
        #arrogance-intro.step,
        #arrogance-colors.step,
        #arrogance-reality.step {
            background: transparent !important; /* No background - transparent over image */
            color: #2c3e50 !important; /* Dark blue text like other sections */
            padding: 35px !important;
            border-radius: 0 !important; 
            box-shadow: none !important; 
            backdrop-filter: none !important; 
            max-width: 520px !important;
            margin-left: 5vw !important; /* Position on left */
            margin-right: auto !important;
            position: relative !important;
            z-index: 5 !important;
            transition: none !important;
        }

        #arrogance-intro.step h3,
        #arrogance-colors.step h3,
        #arrogance-reality.step h3 {
            color: #2c3e50 !important; /* Dark blue for headings */
            margin-bottom: 20px !important;
            font-size: 1.8rem !important;
            text-shadow: none !important; /* Remove shadows */
        }

        #arrogance-intro.step p,
        #arrogance-colors.step p,
        #arrogance-reality.step p {
            color: #34495e !important; /* Slightly lighter dark blue for text */
            line-height: 1.6 !important;
            font-size: 1rem !important;
            text-shadow: none !important; /* Remove shadows */
        }

        #arrogance-intro.step a,
        #arrogance-colors.step a,
        #arrogance-reality.step a {
            color: var(--copenhagen-light-blue) !important; /* Use site's link color */
            text-shadow: none !important; /* Remove shadows */
        }

        /* Fixed styling for transformation section - semi-transparent background for map */
        #transformation-intro.step,
        #transformation-hidalgo.step,
        #transformation-results.step {
            background: rgba(0, 0, 0, 0.75) !important; /* Semi-transparent dark background for map */
            color: white !important; 
            padding: 35px !important;
            border-radius: 12px !important; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important; 
            backdrop-filter: blur(5px) !important; 
            max-width: 520px !important;
            margin-left: 5vw !important; 
            margin-right: auto !important;
            position: relative !important;
            z-index: 5 !important;
            transition: none !important;
        }

        #transformation-intro.step h3,
        #transformation-hidalgo.step h3,
        #transformation-results.step h3 {
            color: white !important; 
            margin-bottom: 20px !important;
            font-size: 1.8rem !important;
            text-shadow: none !important; /* No shadow needed with dark background */
        }

        #transformation-intro.step p,
        #transformation-hidalgo.step p,
        #transformation-results.step p {
            color: #f0f0f0 !important; 
            line-height: 1.6 !important;
            font-size: 1rem !important;
            text-shadow: none !important; /* No shadow needed with dark background */
        }

        #transformation-intro.step a,
        #transformation-hidalgo.step a,
        #transformation-results.step a {
            color: var(--warm-amber) !important; 
        }
    </style>
</head>
<body>
    <div id="sticky-paris-image-container" style="display: none; position: fixed; right: 5%; /* Changed from left */ top: 20vh; width: 40%; max-width: 500px; z-index: 10;">
        <img src="./assets/Paris is Looking Great.webp" alt="Paris Transformation" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    </div>
    
    <div id="sticky-cost-chart-container" style="display: none; position: fixed; right: 5%; top: 15vh; width: 35%; max-width: 400px; z-index: 10;">
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
            <h4 style="margin: 0 0 20px 0; color: #2c3e50; text-align: center; font-size: 1.3rem;">Hvad koster parkering?</h4>
            <div id="cost-chart" style="margin-bottom: 15px;"></div>
            <p style="margin: 0; font-size: 0.9rem; color: #666; text-align: center; font-style: italic;">Kommunen betaler 8x mere end borgerne</p>
        </div>
    </div>

    <div id="sticky-parking-viz-container" style="display: none; position: fixed; right: 5%; top: 10vh; width: 40%; max-width: 500px; z-index: 10;">
        <div id="parking-viz-content"></div>
    </div>
    <div id="map"></div>
    <div id="story"></div>

    <script src="overpass-query.js"></script>
    <script src="parking-data.js"></script>
    <script src="space-comparison.js"></script>
    <script src="impact-stats.js"></script>
    <script src="parking-visualization.js"></script>
    <script src="danish-urbanism.js"></script>
    <script src="fullscreen-slides.js"></script>
    <script src="contribution.js"></script>
    <script src="config.js"></script>
    <script>
    var layerTypes = {
        'fill': ['fill-opacity'],
        'line': ['line-opacity'],
        'circle': ['circle-opacity', 'circle-stroke-opacity'],
        'symbol': ['icon-opacity', 'text-opacity'],
        'raster': ['raster-opacity'],
        'fill-extrusion': ['fill-extrusion-opacity'],
        'heatmap': ['heatmap-opacity']
    }

    var alignments = {
        'left': 'lefty',
        'center': 'centered',
        'right': 'righty',
        'full': 'fully'
    }

    function getLayerPaintType(layer) {
        var layerType = map.getLayer(layer).type;
        return layerTypes[layerType];
    }

    function setLayerOpacity(layer) {
        var paintProps = getLayerPaintType(layer.layer);
        paintProps.forEach(function(prop) {
            var options = {};
            if (layer.duration) {
                var transitionProp = prop + "-transition";
                options = { "duration": layer.duration };
                map.setPaintProperty(layer.layer, transitionProp, options);
            }
            map.setPaintProperty(layer.layer, prop, layer.opacity, options);
        });
    }

    var story = document.getElementById('story');
    var features = document.createElement('div');
    features.setAttribute('id', 'features');

    var header = document.createElement('div');

    if (config.title) {
        var titleText = document.createElement('h1');
        titleText.innerText = config.title;
        header.appendChild(titleText);
    }

    if (config.subtitle) {
        var subtitleText = document.createElement('h2');
        subtitleText.innerText = config.subtitle;
        header.appendChild(subtitleText);
    }

    if (config.byline) {
        var bylineText = document.createElement('p');
        bylineText.innerText = config.byline;
        header.appendChild(bylineText);
    }

    if (header.innerText.length > 0) {
        header.classList.add(config.theme);
        header.setAttribute('id', 'header');
        story.appendChild(header);
    }

    config.chapters.forEach((record, idx) => {
        var container = document.createElement('div');
        var chapter = document.createElement('div');
        
        if (record.title) {
            var title = document.createElement('h3');
            title.innerText = record.title;
            chapter.appendChild(title);
        }
        
        if (record.description) {
            var story = document.createElement('p');
            story.innerHTML = record.description;
            chapter.appendChild(story);
        }
        
        // Add contribution form for the last chapter
        if (idx === config.chapters.length - 1) {
            var form = document.createElement('div');
            form.className = 'contribution-form';
            form.innerHTML = `
                <h4>Bidrag til kortet</h4>
                <p>Hj√¶lp os med at kortl√¶gge private parkeringspladser i K√∏benhavn:</p>
                <input type="text" id="location-name" placeholder="Navn p√• parkeringsplads">
                <input type="text" id="location-address" placeholder="Adresse">
                <textarea id="location-description" placeholder="Beskrivelse (pris, √•bningstider, etc.)"></textarea>
                <input type="file" id="location-photo" accept="image/*">
                <button onclick="submitContribution()">Tilf√∏j til kort</button>
            `;
            chapter.appendChild(form);
        }
        
        container.setAttribute('id', record.id);
        container.classList.add('step');
        if (record.hidden) {
            container.classList.add('hidden');
        }
        
        // Add solid background class if specified
        if (record.solidBackground) {
            container.classList.add('solid-background');
            container.style.setProperty('--solid-bg-color', record.solidBackground);
        }
        
        // Check if this is part of a sticky graphic sequence
        var isStickySequence = record.stickyGraphic && 
            (record.id === 'arrogance-intro' || record.id === 'arrogance-colors' || record.id === 'arrogance-reality' ||
             record.id === 'transformation-intro' || record.id === 'transformation-hidalgo' || record.id === 'transformation-results');
        
        // Add image-slide class and background for image slides
        if (record.isImageSlide) {
            container.classList.add('image-slide');
            if (record.backgroundImage) {
                container.style.backgroundImage = `url('${record.backgroundImage}')`;
            }
            // Wrap content in a content div for image slides
            var contentWrapper = document.createElement('div');
            contentWrapper.className = 'content';
            contentWrapper.appendChild(chapter);
            container.appendChild(contentWrapper);
        } else if (record.stickyGraphic) {
            // Handle sticky graphic pattern
            container.classList.add('sticky-graphic');
            if (record.backgroundImage) {
                container.style.backgroundImage = `url('${record.backgroundImage}')`;
                container.style.backgroundSize = 'cover';
                container.style.backgroundPosition = 'center';
                container.style.backgroundAttachment = 'fixed';
            }
            // Wrap content in a content div for sticky graphics
            var contentWrapper = document.createElement('div');
            contentWrapper.className = 'content';
            contentWrapper.appendChild(chapter);
            container.appendChild(contentWrapper);
            
            // Add sticky sequence class for sticky chapters
            if (isStickySequence) {
                container.classList.add('sticky-sequence-step');
            }
        } else {
            container.appendChild(chapter);
        }
        
        container.classList.add(alignments[record.alignment] || 'centered');
        if (record.onChapterEnter.length === 0 && record.onChapterExit.length === 0) {
            container.setAttribute('data-scrollama-index', idx);
        }
        features.appendChild(container);
    });

    story.appendChild(features);

    var footer = document.createElement('div');

    if (config.footer) {
        var footerText = document.createElement('p');
        footerText.innerHTML = config.footer;
        footer.appendChild(footerText);
    }

    if (footer.innerText.length > 0) {
        footer.classList.add(config.theme);
        footer.setAttribute('id', 'footer');
        story.appendChild(footer);
    }

    mapboxgl.accessToken = config.accessToken;

    const transformRequest = (url) => {
        const hasQuery = url.indexOf("?") !== -1;
        const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
        return {
            url: url + suffix
        }
    }

    // Set initial state based on first chapter
    const firstChapter = config.chapters[0];
    if (firstChapter.solidBackground) {
        document.body.classList.add('solid-background-active');
        document.body.style.backgroundColor = firstChapter.solidBackground;
    }

    var map = new mapboxgl.Map({
        container: 'map',
        style: config.style,
        center: config.chapters[0].location.center,
        zoom: config.chapters[0].location.zoom,
        pitch: config.chapters[0].location.pitch,
        bearing: config.chapters[0].location.bearing,
        accessToken: config.accessToken,
        projection: 'mercator'
    });

    if (config.showMarkers) {
        var marker = new mapboxgl.Marker({ color: config.markerColor });
        marker.setLngLat(config.chapters[0].location.center).addTo(map);
    }

    // Function to show the sticky Paris image
    function showParisStickyImage() {
        const container = document.getElementById('sticky-paris-image-container');
        if (!container) return;
        
        // Set flag to track visibility
        parisStickyVisible = true;
        
        container.style.display = 'block';
        container.style.opacity = '1';
        document.getElementById('map').style.opacity = '0'; // Hide map during this sequence

        // Don't modify transformation chapter styling - they have fixed CSS now
        // The fixed CSS already positions them at margin-left: 5vw which gives space for the image
    }

    // Function to hide the sticky Paris image
    function hideParisStickyImage() {
        const container = document.getElementById('sticky-paris-image-container');
        if (!container || !parisStickyVisible) return;
        
        // Set flag to track visibility
        parisStickyVisible = false;
        
        // Quick fade out like the cost chart and parking viz
        container.style.opacity = '0';
        container.style.transition = 'opacity 0.3s ease-out';
        
        setTimeout(() => {
            container.style.display = 'none';
            container.style.opacity = '1'; // Reset for next time
            container.style.transition = ''; // Reset transition
            document.getElementById('map').style.opacity = '1'; // Show map again
            map.resize();
        }, 300);
    }

    // instantiate the scrollama
    var scroller = scrollama();

    map.on("load", async function() {
        console.log('Map loaded successfully');
        
        if (config.use3dTerrain) {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });
        }

        // Fetch real parking data from Overpass API
        console.log('Fetching real parking data from OpenStreetMap...');
        try {
            const realParkingData = await overpassAPI.fetchParkingData();
            console.log(`Loaded ${realParkingData.features.length} parking locations`);

            // Store globally for space comparison
            globalParkingData = realParkingData;

            // Add parking data source with real data
            map.addSource('parking-spots', {
                'type': 'geojson',
                'data': realParkingData
            });
            console.log('Added parking data source to map');

            // Add parking spots layer
            map.addLayer({
                'id': 'parking-spots-layer',
                'type': 'circle',
                'source': 'parking-spots',
                'paint': {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        10, 4,
                        15, 8,
                        20, 16
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['/', ['get', 'occupancy'], ['get', 'capacity']],
                        0, '#00ff00',    // Green for empty
                        0.5, '#ffff00',  // Yellow for half full
                        1, '#ff0000'     // Red for full
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-opacity': 0.8
                }
            });
            console.log('Added parking spots layer to map');
        } catch (error) {
            console.error('Error loading parking data:', error);
        }

        // Add click event for parking spots
        map.on('click', 'parking-spots-layer', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;
            const occupancyRate = Math.round((properties.occupancy / properties.capacity) * 100);
            
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(`
                    <div style="padding: 10px;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">${properties.name}</h3>
                        <p style="margin: 5px 0;"><strong>Adresse:</strong> ${properties.address}</p>
                        <p style="margin: 5px 0;"><strong>Kapacitet:</strong> ${properties.capacity} pladser</p>
                        <p style="margin: 5px 0;"><strong>Bel√¶gning:</strong> ${properties.occupancy}/${properties.capacity} (${occupancyRate}%)</p>
                        <p style="margin: 5px 0;"><strong>Pris:</strong> ${properties.price_per_hour} kr/time</p>
                        <p style="margin: 5px 0; font-style: italic;">${properties.description}</p>
                        <div style="margin-top: 10px; padding: 5px; background: ${occupancyRate < 30 ? '#d4edda' : occupancyRate < 70 ? '#fff3cd' : '#f8d7da'}; border-radius: 3px;">
                            <strong>${occupancyRate < 30 ? '‚úÖ Mange ledige pladser' : occupancyRate < 70 ? '‚ö†Ô∏è Nogle ledige pladser' : '‚ùå N√¶sten fuldt'}</strong>
                        </div>
                    </div>
                `)
                .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'parking-spots-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'parking-spots-layer', () => {
            map.getCanvas().style.cursor = '';
        });

        // Load user contributions
        contributionManager.loadContributionsToMap();

        // setup the instance, pass callback functions
        scroller
        .setup({
            step: '.step',
            offset: 0.5,
            progress: true
        })
        .onStepEnter(async response => {
            const chapter = config.chapters.find(chap => chap.id === response.element.id);
            response.element.classList.add('active');
            
            // Handle solid background
            if (chapter.solidBackground) {
                document.body.classList.add('solid-background-active');
                document.body.style.setProperty('--solid-bg-color', chapter.solidBackground);
                // Use smooth transition instead of instant change
                setTimeout(() => {
                    document.body.style.backgroundColor = chapter.solidBackground;
                }, 50);
            } else {
                document.body.classList.remove('solid-background-active');
                // Use smooth transition instead of instant change
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 50);
            }
            
            // Check if we're in the arrogance sticky graphic sequence
            const isArroganceSequence = chapter.stickyGraphic && 
                (chapter.id === 'arrogance-intro' || chapter.id === 'arrogance-colors' || chapter.id === 'arrogance-reality');
            
            // Check if we're in the transformation sticky graphic sequence  
            const isTransformationSequence = chapter.stickyGraphic && 
                (chapter.id === 'transformation-intro' || chapter.id === 'transformation-hidalgo' || chapter.id === 'transformation-results');
            
            // Handle arrogance sequence
            if (isArroganceSequence) {
                document.body.classList.add('sticky-sequence-active', 'arrogance-sequence');
                document.body.classList.remove('transformation-sequence');
                
                // Only animate the map on the first step of the sequence
                if (chapter.id === 'arrogance-intro') {
                    map[chapter.mapAnimation || 'flyTo'](chapter.location);
                }
            }
            // Handle transformation sequence
            else if (isTransformationSequence) {
                document.body.classList.add('sticky-sequence-active', 'transformation-sequence');
                document.body.classList.remove('arrogance-sequence');
                
                // Only animate the map on the first step of the sequence
                if (chapter.id === 'transformation-intro') {
                    map[chapter.mapAnimation || 'flyTo'](chapter.location);
                }
            }
            // Handle normal steps
            else {
                document.body.classList.remove('sticky-sequence-active', 'arrogance-sequence', 'transformation-sequence');
                // Normal map animation for non-sticky steps
                map[chapter.mapAnimation || 'flyTo'](chapter.location);
            }

            // Handle callback function
            if (chapter.callback && typeof window[chapter.callback] === 'function') {
                window[chapter.callback]();
            }

            // Handle onChapterEnter
            if (chapter.onChapterEnter.length > 0) {
                chapter.onChapterEnter.forEach(callback => {
                    if (typeof window[callback] === 'function') {
                        window[callback]();
                    }
                });
            }

            if (chapter.rotateAnimation) {
                map.once('moveend', () => {
                    const rotateNumber = map.getBearing();
                    map.rotateTo(rotateNumber + 180, {
                        duration: 30000, easing: function (t) {
                            return t;
                        }
                    });
                });
            }

            if (config.showMarkers) {
                marker.setLngLat(chapter.location.center);
            }
        })
        .onStepExit(response => {
            response.element.classList.remove('active');
            
            // Handle sticky sequence cleanup
            const chapter = config.chapters.find(chap => chap.id === response.element.id);
            
            // If exiting the last step of arrogance sequence
            if (chapter && chapter.id === 'arrogance-reality') {
                document.body.classList.remove('arrogance-sequence');
            }
            
            // If exiting the last step of transformation sequence
            if (chapter && chapter.id === 'transformation-results') {
                document.body.classList.remove('transformation-sequence');
            }
            
            // Handle onChapterExit callbacks
            if (chapter && chapter.onChapterExit && chapter.onChapterExit.length > 0) {
                chapter.onChapterExit.forEach(callback => {
                    if (typeof window[callback] === 'function') {
                        window[callback]();
                    }
                });
            }
        });
    });

    // resize function to avoid overlap on mobile
    window.addEventListener('resize', scroller.resize);

    // Show intro section when it comes into view
    const introSection = document.getElementById('intro');
    if (introSection) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('show');
                    observer.unobserve(entry.target); // Only trigger once
                }
            });
        }, {
            threshold: 0.1, // Trigger when 10% of the element is visible
            rootMargin: '0px 0px -10% 0px' // Start animation slightly before element is fully in view
        });
        
        observer.observe(introSection);
    }

    // Global variable to store parking data for space comparison
    let globalParkingData = null;

    // Space comparison (Michael Szell)
    function showSpaceComparison() {
        const chapter = config.chapters.find(chap => chap.id === 'space-stats');
        // Ensure the container exists and is the correct one for this chapter's content
        const chapterElement = document.getElementById('space-stats');
        if (!chapterElement) {
            console.error("Chapter element 'space-stats' not found for space comparison.");
            return;
        }
        
        // The content of the chapter is directly in the chapter div, not in mapboxgl-scroll-overlay-content for this setup
        // If the structure is <div id="space-stats" class="step"><h3>Title</h3><p>Desc</p><div><!-- content from js here --></div></div>
        // We need to ensure we are targeting the correct div for injection or clearing previous content.
        // For simplicity, let's assume the chapter description is static and we append/replace a dedicated div for the comparison.

        // If the chapter's main div should be filled, ensure it's clean or find a specific target inside it.
        // Let's look at how chapters are built:
        // var chapterDiv = document.createElement('div'); (used for title/desc)
        // var container = document.createElement('div'); (this is the .step with the ID)
        // container.appendChild(chapterDiv);
        // So, the content from spaceComparison should go into the container, perhaps after the chapterDiv.

        let targetContainer = chapterElement.querySelector('.space-comparison-container');
        if (!targetContainer) {
            targetContainer = document.createElement('div');
            targetContainer.className = 'space-comparison-container';
            // Insert after the existing title and description which are in a direct child div of chapterElement
            const existingContent = chapterElement.querySelector('div'); // The one holding title/desc
            if (existingContent && existingContent.nextSibling) {
                chapterElement.insertBefore(targetContainer, existingContent.nextSibling);
            } else if (existingContent) {
                chapterElement.appendChild(targetContainer);
            } else { // If no initial title/desc div, just append to chapter element
                chapterElement.appendChild(targetContainer);
            }
        }
        
        const visualizationData = spaceComparison.generateVisualization(); // No longer needs globalParkingData
        const html = spaceComparison.createComparisonHTML(visualizationData);
        targetContainer.innerHTML = html; // Use the dedicated container
    }

    // Callback function for impact statistics
    function showImpactStats() {
        if (globalParkingData) {
            impactStats.addToChapter('aktuel-bel√¶gning', globalParkingData);
        }
    }

    // Callback function for Danish urbanism achievements
    function showDanishUrbanism() {
        danishUrbanism.addToChapter('dansk-paradoks');
    }

    // Function to prepare background for smoother transitions
    function prepareNextChapterBackground() {
        // Add a subtle pre-transition to make background changes smoother
        const body = document.body;
        body.style.transition = 'background-color 0.8s ease-in-out';
        
        // Pre-warm the background color slightly
        setTimeout(() => {
            body.style.backgroundColor = 'rgba(52, 73, 94, 0.3)';
        }, 100);
        
        // Reset after a moment
        setTimeout(() => {
            body.style.backgroundColor = '';
            body.style.transition = '';
        }, 1500);
    }

    // Function to prepare dark background transition for parking visualization
    function prepareDarkBackground() {
        const body = document.body;
        body.style.transition = 'background-color 0.6s ease-in-out';
        
        // Start transitioning to dark background early
        setTimeout(() => {
            body.style.backgroundColor = 'rgba(30, 58, 138, 0.85)';
        }, 200);
    }

    // Function to complete dark background transition
    function completeDarkBackground() {
        const body = document.body;
        body.style.backgroundColor = '#1e3a8a'; // Full dark blue
    }

    // Function to clear dark background early
    function clearDarkBackground() {
        const body = document.body;
        body.style.transition = 'background-color 0.5s ease-out';
        
        // Start clearing background early
        setTimeout(() => {
            body.style.backgroundColor = '';
        }, 100);
        
        // Reset transition
        setTimeout(() => {
            body.style.transition = '';
        }, 600);
    }

    // Flag to ensure cost chart animation only happens once
    let costChartAnimated = false;

    // Flag to ensure parking visualization only shows/hides properly
    let parkingVizVisible = false;

    // Flag to ensure Paris sticky image only shows/hides properly
    let parisStickyVisible = false;

    // Function to show the sticky cost comparison chart
    function showCostChart() {
        const chartContainer = document.getElementById('sticky-cost-chart-container');
        if (!chartContainer) return;
        
        chartContainer.style.display = 'block';
        chartContainer.style.opacity = '1';
        
        // Don't modify the kommunale-lejeaftaler chapter styling - it has fixed CSS
        // Just ensure the chart doesn't overlap by positioning it correctly
        
        // Also adjust vesterbro-parking chapter for consistency when chart is visible
        const vesterbro = document.getElementById('vesterbro-parking');
        if (vesterbro) {
            vesterbro.style.marginLeft = '5vw';
            vesterbro.style.marginRight = 'auto';
            vesterbro.style.maxWidth = 'calc(50vw - 40px)';
            vesterbro.style.position = 'relative';
            vesterbro.style.zIndex = '5';
        }
        
        // Only animate if it hasn't been animated before
        if (!costChartAnimated) {
            costChartAnimated = true;
            
            // Create minimal proportional bar chart
            const chartDiv = document.getElementById('cost-chart');
            chartDiv.innerHTML = '';
            
            const driverPays = 2375;
            const taxpayerSubsidy = 19000;
            const totalCost = driverPays + taxpayerSubsidy;
            
            const driverPercentage = (driverPays / totalCost) * 100;
            const taxpayerPercentage = (taxpayerSubsidy / totalCost) * 100;
            
            // Main container
            const mainContainer = document.createElement('div');
            mainContainer.style.cssText = 'margin-bottom: 20px;';
            
            // Single bar container
            const barContainer = document.createElement('div');
            barContainer.style.cssText = 'position: relative; height: 80px; background: var(--glass-bg); border-radius: 12px; overflow: hidden; backdrop-filter: blur(5px); margin-bottom: 20px;';
            
            // Driver payment section (tiny)
            const driverSection = document.createElement('div');
            driverSection.style.cssText = `
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 0%;
                background: linear-gradient(135deg, var(--danish-green), var(--warm-amber));
                transition: width 2.5s ease;
                border-radius: 12px 0 0 12px;
            `;
            
            // Taxpayer subsidy section (huge)
            const taxpayerSection = document.createElement('div');
            taxpayerSection.style.cssText = `
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                width: 0%;
                background: linear-gradient(135deg, var(--problem-red), #b91c1c);
                transition: width 2.5s ease 0.8s;
                border-radius: 0 12px 12px 0;
            `;
            
            // Labels container - simplified
            const labelsContainer = document.createElement('div');
            labelsContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
            
            // Driver label - minimal
            const driverLabel = document.createElement('div');
            driverLabel.style.cssText = 'color: var(--danish-green); font-weight: 700; font-size: 1rem;';
            driverLabel.textContent = `Bilister: ${driverPays.toLocaleString('da-DK')} kr`;
            
            // VS separator
            const separator = document.createElement('div');
            separator.style.cssText = 'color: rgba(255,255,255,0.7); font-weight: 300; font-size: 0.9rem;';
            separator.textContent = 'vs';
            
            // Taxpayer label - minimal
            const taxpayerLabel = document.createElement('div');
            taxpayerLabel.style.cssText = 'color: var(--problem-red); font-weight: 700; font-size: 1rem; text-align: right;';
            taxpayerLabel.textContent = `Skatteydere: ${taxpayerSubsidy.toLocaleString('da-DK')} kr`;
            
            // Bottom impact note - very minimal
            const impactNote = document.createElement('div');
            impactNote.innerHTML = '<strong>8x</strong> forskel';
            impactNote.style.cssText = 'color: rgba(255,255,255,0.95); text-align: center; margin-top: 15px; font-size: 1.1rem; font-weight: 600;';
            
            // Assemble elements
            labelsContainer.appendChild(driverLabel);
            labelsContainer.appendChild(separator);
            labelsContainer.appendChild(taxpayerLabel);
            
            barContainer.appendChild(driverSection);
            barContainer.appendChild(taxpayerSection);
            
            mainContainer.appendChild(barContainer);
            mainContainer.appendChild(labelsContainer);
            mainContainer.appendChild(impactNote);
            
            chartDiv.appendChild(mainContainer);
            
            // Trigger animation only once
            setTimeout(() => {
                driverSection.style.width = `${driverPercentage}%`;
                taxpayerSection.style.width = `${taxpayerPercentage}%`;
            }, 400);
        }
    }

    // Function to hide the sticky cost comparison chart
    function hideCostChart() {
        const chartContainer = document.getElementById('sticky-cost-chart-container');
        if (!chartContainer) return;
        
        // Quick fade out
        chartContainer.style.opacity = '0';
        chartContainer.style.transition = 'opacity 0.3s ease-out';
        
        setTimeout(() => {
            chartContainer.style.display = 'none';
            chartContainer.style.opacity = '1'; // Reset for next time
            chartContainer.style.transition = ''; // Reset transition
        }, 300);
        
        // Don't modify kommunale-lejeaftaler styling - it has fixed CSS now
        
        // Reset vesterbro-parking chapter styling
        const vesterbro = document.getElementById('vesterbro-parking');
        if (vesterbro) {
            vesterbro.style.transition = 'all 0.3s ease-out';
            vesterbro.style.marginLeft = '';
            vesterbro.style.marginRight = '';
            vesterbro.style.maxWidth = '';
            vesterbro.style.position = '';
            vesterbro.style.zIndex = '';
        }
    }

    // Function to show the sticky parking visualization
    function showParkingVisualization() {
        const container = document.getElementById('sticky-parking-viz-container');
        if (!container) return;
        
        // Set flag to track visibility
        parkingVizVisible = true;
        
        container.style.display = 'block';
        container.style.opacity = '1';
        
        // Initialize the parking visualization in the container
        const vizContainer = document.getElementById('parking-viz-content');
        if (vizContainer && typeof parkingVisualization !== 'undefined' && parkingVisualization.createVisualization) {
            // Clear any existing content
            vizContainer.innerHTML = '';
            parkingVisualization.createVisualization(vizContainer);
        }
    }

    // Function to hide the sticky parking visualization
    function hideParkingVisualization() {
        const container = document.getElementById('sticky-parking-viz-container');
        if (!container || !parkingVizVisible) return;
        
        // Set flag to track visibility
        parkingVizVisible = false;
        
        // Quick fade out like the cost chart
        container.style.opacity = '0';
        container.style.transition = 'opacity 0.3s ease-out';
        
        setTimeout(() => {
            container.style.display = 'none';
            container.style.opacity = '1'; // Reset for next time
            container.style.transition = ''; // Reset transition
            
            // Clear the visualization content
            const vizContainer = document.getElementById('parking-viz-content');
            if (vizContainer) {
                vizContainer.innerHTML = '';
            }
        }, 300);
    }

    // Function to clear the arrogance sequence when scrolling back
    function clearArroganceSequence() {
        // Remove sticky sequence classes
        document.body.classList.remove('sticky-sequence-active', 'arrogance-sequence');
        
        // Clear any background images or overlays
        const stickyOverlay = document.querySelector('.sticky-graphic-overlay');
        if (stickyOverlay) {
            stickyOverlay.style.opacity = '0';
            stickyOverlay.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => {
                stickyOverlay.style.display = 'none';
                stickyOverlay.style.opacity = '1';
                stickyOverlay.style.transition = '';
            }, 300);
        }
    }
    </script>

</body>
</html> 